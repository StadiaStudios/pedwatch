<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../assets/favicon.png">
    <title>PedWatch | Video Player</title>
    <link rel="manifest" href="manifest.json">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for the playlist */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; /* Dark gray track */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; /* Medium gray thumb */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Ensure the YouTube player iframe takes full space */
        #youtubePlayer iframe {
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        // --- Tailwind Configuration ---
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#121212',
                        'card-dark': '#1f1f1f',
                        'text-light': '#ffffff',
                        'accent-red': 'orange',
                    }
                }
            }
        }
        
        // 1. Load the YouTube IFrame Player API script asynchronously.
        // This is necessary for embedding and controlling YouTube videos via JavaScript.
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        
        // --- Global Application State & Constants ---
        let player; // Global variable for the YT Player object
        let currentVideoIndex = 0;
        let countdownInterval = null;
        const AUTOPLAY_DELAY_SECONDS = 5;
        
        const playlist = [
            // Using creative commons/public domain YouTube videos for reliable playback
            { id: 1, title: "OG Pred Gets Hissy With Me!", videoId: "HSQNlGa2cnM", duration: "26m", publisher: "Skeeter Jean" }, 
            { id: 2, title: "DIABOLICAL Grandpa Pred Unveils his Darkest Secret...", videoId: "bZ5Z9Jse7MI", duration: "48m", publisher: "Skeeter Jean" }, 
            { id: 3, title: "Pred Said he Didn't Want Cops Pulling up on Him, So I had the Cops Pull up on Him", videoId: "Q1ti6soPQJU", duration: "17m", publisher: "Skeeter Jean" },
            { id: 4, title: "Epic Cinematic Loop", videoId: "3e_T6kO23G0", duration: "1m", publisher: "RoyaltyFreeMusic" },
            { id: 5, title: "Chill Lofi Beats", videoId: "jfKfPfyBkdg", duration: "5m", publisher: "Lofi Girl" },
        ];


        // 2. This function is called automatically by the YouTube API when the script is loaded.
        function onYouTubeIframeAPIReady() {
            // Get necessary DOM elements
            const videoTitleEl = document.getElementById('videoTitle');
            const videoPublisherEl = document.getElementById('videoPublisher');
            const currentIndexEl = document.getElementById('currentIndex');
            const playlistContainer = document.getElementById('playlistContainer');
            const countdownOverlay = document.getElementById('countdownOverlay');
            const countdownMessage = document.getElementById('countdownMessage');
            const cancelAutoplayButton = document.getElementById('cancelAutoplayButton');

            /**
             * Clears the countdown timer and hides the overlay.
             */
            const stopAutoplay = () => {
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                countdownOverlay.classList.remove('opacity-100', 'pointer-events-auto');
                countdownOverlay.classList.add('opacity-0', 'pointer-events-none');
            };

            /**
             * Plays the next video and resets the state.
             */
            const playNextVideo = () => {
                stopAutoplay();
                loadVideo(currentVideoIndex + 1);
            };

            /**
             * Starts the 5-second auto-play countdown.
             */
            const startAutoplayCountdown = () => {
                stopAutoplay(); 

                let count = AUTOPLAY_DELAY_SECONDS;
                countdownMessage.textContent = `Next video starting in ${count}...`;
                
                // Show the overlay and enable interaction
                countdownOverlay.classList.add('opacity-100', 'pointer-events-auto');
                countdownOverlay.classList.remove('opacity-0', 'pointer-events-none');

                countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownMessage.textContent = `Next video starting in ${count}...`;
                    } else {
                        // Time's up, play the next video
                        playNextVideo();
                    }
                }, 1000);
            };

            /**
             * Handles the state change event from the YouTube player.
             * YT.PlayerState.ENDED (0) is the trigger for autoplay.
             */
            function onPlayerStateChange(event) {
                if (event.data === YT.PlayerState.ENDED) {
                    startAutoplayCountdown();
                } 
                // If the user manually starts playing while the countdown is visible, cancel it.
                if (event.data === YT.PlayerState.PLAYING) {
                    stopAutoplay();
                }
            }


            /**
             * Loads and plays a video from the playlist using its YouTube ID.
             * @param {number} index - The index of the video to load.
             */
            const loadVideo = (index) => {
                // Ensure index wraps around if it exceeds the playlist length
                currentVideoIndex = index % playlist.length;
                if (currentVideoIndex < 0) {
                    currentVideoIndex = playlist.length - 1;
                }

                const video = playlist[currentVideoIndex];
                
                if (player && player.loadVideoById) {
                    // Load and play the video by its YouTube ID
                    player.loadVideoById({
                        videoId: video.videoId,
                        startSeconds: 0, 
                        suggestedQuality: 'large'
                    });
                }

                videoTitleEl.textContent = video.title;
                videoPublisherEl.textContent = `By: ${video.publisher}`;
                currentIndexEl.textContent = currentVideoIndex;

                renderPlaylist(video.videoId);
            };

            /**
             * Renders the playlist in the sidebar, marking the active video.
             * @param {string} activeVideoId - The YouTube ID of the currently playing video.
             */
            const renderPlaylist = (activeVideoId) => {
                playlistContainer.innerHTML = ''; // Clear existing content
                playlist.forEach((video, index) => {
                    const isPlaying = video.videoId === activeVideoId;
                    const nextInQueue = index === (currentVideoIndex + 1) % playlist.length;

                    const item = document.createElement('div');
                    item.className = `p-3 rounded-lg flex cursor-pointer transition duration-200 border border-transparent 
                                     ${isPlaying ? 'bg-accent-red hover:bg-accent-red/90 text-primary-dark font-bold shadow-xl' : 
                                                  'bg-gray-800 hover:bg-gray-700'}`;
                    
                    // Add a small badge if it's next in queue
                    const queueBadge = nextInQueue && !isPlaying ? `<span class="text-xs font-medium ml-2 text-green-400">NEXT</span>` : '';

                    item.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-sm truncate ${isPlaying ? 'text-primary-dark' : 'text-text-light'}">${video.title}</p>
                            <p class="text-xs ${isPlaying ? 'text-primary-dark/80' : 'text-gray-400'}">${video.duration} ${queueBadge}</p>
                        </div>
                    `;
                    
                    // Add a visual indicator if playing
                    if (isPlaying) {
                         item.innerHTML += `
                            <svg class="w-5 h-5 ml-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4.004a1 1 0 001.555.832l3.86-2.002a1 1 0 000-1.664l-3.86-2.002z" clip-rule="evenodd"></path>
                            </svg>
                         `;
                    }

                    item.addEventListener('click', () => {
                        stopAutoplay();
                        loadVideo(index);
                    });
                    playlistContainer.appendChild(item);
                });
            };

            // 3. Initialize the YouTube Player
            player = new YT.Player('youtubePlayer', {
                height: '100%',
                width: '100%',
                videoId: playlist[currentVideoIndex].videoId, // Initial video ID
                playerVars: {
                    'playsinline': 1,
                    'autoplay': 1, // Attempt to autoplay the first video
                    'controls': 1,
                    'rel': 0, 
                    'modestbranding': 1,
                    'iv_load_policy': 3 
                },
                events: {
                    'onReady': () => {
                        // Initial load of UI data
                        videoTitleEl.textContent = playlist[currentVideoIndex].title;
                        videoPublisherEl.textContent = `By: ${playlist[currentVideoIndex].publisher}`;
                        currentIndexEl.textContent = currentVideoIndex;
                        renderPlaylist(playlist[currentVideoIndex].videoId);
                    },
                    'onStateChange': onPlayerStateChange // Crucial for detecting video end
                }
            });

            // 4. Cancel button event: Stop the countdown
            cancelAutoplayButton.addEventListener('click', (e) => {
                e.stopPropagation();
                stopAutoplay();
                if (player && player.stopVideo) {
                    player.stopVideo(); // Stop the video entirely
                }
            });
        }
    </script>
</head>
<body class="bg-primary-dark text-text-light font-sans min-h-screen">

    <!-- Top Navigation Bar -->
    <nav class="bg-card-dark shadow-md">
        <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo/Title -->
                <h1 class="text-3xl font-extrabold text-[orange] tracking-wider">PedWatch <span class="text-white text-xl font-light">| Skeeter Jean</span></h1>

                <!-- Navigation Links -->
                <div class="flex items-center space-x-6">
                    <a href="../index.html" class="text-gray-300 hover:text-accent-red transition duration-150 text-sm font-medium">Home</a>
                </div>
            </div>
        </div>
    </nav>

    <div id="app" class="p-4 md:p-8 pt-6 md:pt-8">
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Video Player Area (Takes 2/3 on desktop, full width on mobile) -->
            <div class="lg:col-span-2">
                <div class="aspect-video bg-card-dark rounded-lg shadow-2xl overflow-hidden relative">
                    <!-- YouTube Player Host Element -->
                    <div id="youtubePlayer" class="w-full h-full"></div>
                    
                    <!-- Autoplay Countdown Overlay -->
                    <div id="countdownOverlay" class="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
                        <p id="countdownMessage" class="text-2xl font-bold mb-4 text-center">Next video starting in 5...</p>
                        <button id="cancelAutoplayButton" class="px-6 py-2 bg-white text-primary-dark font-semibold rounded-full hover:bg-gray-300 transition duration-150 shadow-lg">
                            Cancel Auto-play
                        </button>
                    </div>
                </div>

                <!-- Video Details -->
                <div class="mt-4">
                    <h2 id="videoTitle" class="text-xl md:text-2xl font-bold mb-1"></h2>
                    <p id="videoPublisher" class="text-sm text-gray-400 mb-2"></p>
                    <p class="text-sm text-gray-400">Playlist Index: <span id="currentIndex">0</span></p>
                </div>
            </div>

            <!-- Playlist Sidebar (Takes 1/3 on desktop, stacked below on mobile) -->
            <div class="lg:col-span-1 bg-card-dark rounded-lg p-4 shadow-lg">
                <h3 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Up Next</h3>
                <div id="playlistContainer" class="space-y-3 max-h-[600px] lg:max-h-[800px] overflow-y-auto custom-scrollbar">
                    <!-- Playlist items will be injected here -->
                </div>
            </div>
        </div>
    </div>
</body>
</html>
